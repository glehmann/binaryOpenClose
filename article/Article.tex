\documentclass{InsightArticle}
\usepackage[dvips,
bookmarks,
bookmarksopen,
backref,
colorlinks,linkcolor={blue},citecolor={blue},urlcolor={blue},
]{hyperref}
\usepackage{listings}
\usepackage{subfigure}
\usepackage{graphicx}


\title{Binary morphological closing and opening image filters}
% \release{1}
\author{Ga\"etan Lehmann}
\authoraddress{Unit\'e de Biologie du D\'eveloppement et de la Reproduction, Institut National de la Recherche Agronomique, 78350 Jouy-en-Josas, France}


\begin{document}
\maketitle

\ifhtml
\chapter*{Front Matter\label{front}}
\fi


\begin{abstract}
\noindent
Binary morphological closing and opening image filters remove structures smaller
than the structuring element in a binary image.

\keyword{mathematical morphology, binary image, opening, closing}
\end{abstract}

% \tableofcontents


\section{Description}

Binary morphological closing and opening image filters remove structures smaller
than the structuring element in a binary image. These filters suppress the
boundary effects and maintain the background values.

\section{Implementation}

BinaryMorphologicalClosingImageFilter and BinaryMorphologicalOpeningImageFilter
are mainly a sequence of filters.

BinaryMorphologicalOpeningImageFilter runs a BinaryErodeImageFilter followed by
a BinaryDilateImageFilter. Some background pixels may appear in the output image
therefore the user can choose the value of added background pixels.

BinaryMorphologicalClosingImageFilter runs a BinaryDilateImageFilter followed by
a BinaryErodeImageFilter\footnote{BinaryMorphologicalClosingImageFilter and
BinaryMorphologicalOpeningImageFilter use intensively BinaryDilateImageFilter
and BinaryErodeImageFilter, but a bug occures in these filters when the
requested region is smaller than the available one. A version of these filters
which fixes that bug can be found in the archive. More details at
http://public.kitware.com/pipermail/insight-users/2005-September/014844.html.}.
If SafeBorder is true (setting by default), the BinaryDilateImageFilter is
preceded by a ConstantPadImageFilter and the BinaryErodeImageFilter is followed
by a CropImageFilter in order to avoid border effects. Finally,
BinaryMorphologicalClosingImageFilter copy the background pixels from the input
image to avoid the modifications of the background done by the
BinaryErodeImageFilter. BinaryMorphologicalClosingImageFilter will never add
background pixels so the background value used for the BinaryErodeImageFilter is
automatically chosen.

The pad and crop transformations are mandatory to avoid border effects, and can't
be replaced by boundary conditions, as shown in Figure~\ref{boundary}.
Correct example is shown in Figure~\ref{safe}.

\begin{figure}[htbp]
\begin{center}
\subfigure[Border is backgroung both for dilation and erosion.]{\includegraphics[scale=0.7]{close_border00}}
\subfigure[Border is foreground for dilation, and background for erosion. This one correspond to option SafeBorder=false (see Figure~\ref{unsafe}).]{\includegraphics[scale=0.7]{close_border01}}
\subfigure[Border is background for dilation, and foreground for erosion.]{\includegraphics[scale=0.7]{close_border10}}
\subfigure[Border is foreground both for dilation and erosion.]{\includegraphics[scale=0.7]{close_border11}}
\caption{Result on border effects for different boundary conditions on an image
closed by a disc of radius 40. The input image is shown in Figure~\ref{input}.
Note that 
background values are not preserved here because those images have been obtained
with a BinaryDilateImageFilter and a BinaryErodeImageFilter, and not with a
BinaryMorphologicalClosingImageFilter.\label{boundary}}
\end{center}
\end{figure}


\section{Performance}
A timing test comparing performance on a $371 \times 371 \times 34$
image showed that the SafeBorder option has a significant impact on execution
time. This result justify to be able to desactivate the SafeBorder
option, for the case where the user is sure he won't have border
effects.

The cost to take care of background values is quite small, and should
not be a problem in most of cases.

The execution time is different for the 2 foreground values. It is caused by
the BinaryEroderImageFilter and BinaryDilateImageFilter used internally:
the execution time of those filters is highly dependent of data.

The results achieved on an Pentium 4
Processor 3200 MHz with 2048Kb cache, 2048 Mb of RAM and gcc
4.0.2 are shown in Table~\ref{perf}.

\begin{table}[htbp]
\centering
\begin{tabular}{cccccc}
\hline
foreground & dilate and erode & erode and dilate & unsafe close & safe close & open  \\
\hline
\hline
100 & 18.434 s & 15.686 s & 18.68 s  & 25.758 s & 15.664 s \\
200 & 14.716 s & 11.74 s  & 14.746 s & 18.444 s & 11.868 s \\
\hline
\end{tabular}
\caption{Execution time.\label{perf}}
\end{table}


\section{Usage}

First of all, the user must create a structuring element. As usual, the headers
must be included

\small \begin{verbatim}
#include "itkBinaryBallStructuringElement.h"
#include "itkBinaryMorphologicalOpeningImageFilter.h"
#include "itkBinaryMorphologicalClosingImageFilter.h"
\end{verbatim} \normalsize
Create the structuring element - a disk of radius 40
\small \begin{verbatim}
typedef itk::BinaryBallStructuringElement
  < PType, dim> KernelType;
KernelType ball;
KernelType::SizeType ballSize;
ballSize.Fill( 40 );
ball.SetRadius(ballSize);
ball.CreateStructuringElement();
\end{verbatim} \normalsize
Create the closing filter
\small \begin{verbatim}
typedef itk::BinaryMorphologicalClosingImageFilter
  < IType, IType, KernelType > CloseType;
CloseType::Pointer close = CloseType::New();
close->SetInput( filter->GetOutput() );
close->SetKernel( ball );
\end{verbatim} \normalsize
The SetSafeBorder() method can be used to disable the safe border option (see
Figure~\ref{unsafe})
\small \begin{verbatim}
close->SetSafeBorder( false );
\end{verbatim} \normalsize
The \code{SetForegroundValue()} can be used to set the foreground value used for
the closing. The default is \code{itk::NumericTraits$<$ PType $>$::max()}
\small \begin{verbatim}
close->SetForegroundValue( 200 );
\end{verbatim} \normalsize
Create the opening filter
\small \begin{verbatim}
typedef itk::BinaryMorphologicalOpeningImageFilter
  < IType, IType, KernelType > OpenType;
OpenType::Pointer erode = OpenType::New();
erode->SetInput( filter->GetOutput() );
erode->SetKernel( ball );
\end{verbatim} \normalsize
The \code{SetForegroundValue()} can be used to set the foreground value used for
the opening. The default is \code{itk::NumericTraits$<$ PType $>$::max()}
\small \begin{verbatim}
erode->SetForegroundValue( 200 );
\end{verbatim} \normalsize
The SetBackgroundValue() method can be used to set the value of pixels which
will be moved to backgound (see Figure~\ref{open}). The default is
itk::NumericTraits$<$ PType $>$::Zero
\small \begin{verbatim}
erode->SetBackgroundValue( 150 );
\end{verbatim} \normalsize

\section{Examples}

\begin{figure}[b]
\centering
\includegraphics{2th_cthead1.eps}
\caption{The input image. The image contains 3 pixels values: black (0), dark
grey (100) and light grey (200). Each those values can be used as foreground
value. In the next examples, the light grey is used as foreground and the other
values as background.\label{input}}
\end{figure}

\begin{figure}
\centering
\includegraphics{close.eps}
\caption{The input image closed by a disc of radius 40, with SafeBorder=true.
All background regions smaller than the structuring element are filled with the
foreground value. The other background regions are not modified.\label{safe}}
\end{figure}

\begin{figure}
\centering
\includegraphics{close-unsafe.eps}
\caption{The input image closed by a disc of radius 40, with SafeBorder=false.
The border effects are clearly visible on the right and bottom side of the
image, but are also there on the top and left side of the image.
SafeBorder=false must be used very carefully.\label{unsafe}}
\end{figure}

\begin{figure}
\centering
\includegraphics{open.eps}
\caption{The opened image with a disc of radius 8. Only the foreground (light
grey) regions of the input image where the structuring element fit are kept in
light grey; the other foreground regions are added to the background (in-between
grey (150)).\label{open}}
\end{figure}

\end{document}
